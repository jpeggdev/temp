# SFTP Batch Processing - 2025.07.21 Prompts

## Session Context
**Project**: Hub Plus API - SFTP Batch Processing Implementation  
**Date**: July 21, 2025  
**Participants**: User, AP Orchestrator, Analyst Agent, Developer Agent  
**Outcome**: Complete TDD implementation of SFTP batch processing with audit trail

---

## Literal Prompt Sequence

### 1. Initial Feature Request
```
I have some existing files here tests/Files/usps/sftp/ that represent SFTP files that come over from USPS. I would like to create a way to process these files and put them into the database by building upon the existing UploadPostageExpenseService. However, there are some column differences in the SFTP files vs what we have in the current UploadPostageExpenseService. The SFTP files have these columns Job ID, Number of Pieces, Transaction Amount and I need to map them to the existing BatchPostageRecordMap columns reference, quantity_sent, and cost respectively.

I would also like to be able to keep track of which SFTP files we have processed so we don't process the same file twice.
```

### 2. Design Validation
```
this is a very solid design. I prefer "PostageProcessedFile" over "ProcessedFile" - nice choice there!
```

### 3. TDD Methodology Request
```
I would like to adopt a specific approach to TDD. I want to test-drive the entity by first test-driving the repository class. I want to put the test files in the tests directory, and I want to use AbstractKernelTestCase so that the tests actually interact with the real database. When the tests all pass, then I can run bin/console doctrine:migrations:diff to generate a migration from the entities. Does that sound good?
```

### 4. Critical Documentation Request
```
This is a great approach! Could you capture this as a "Critical Directive" in the main CLAUDE.md such that any future agents or future sessions will adopt this approach going forward?
```

### 5. Implementation Go-Ahead
```
sounds great! let's proceed with this plan
```

### 6. Party Command (Not Recognized)
```
/party
```

### 7. Documentation Organization
```
Let's create a project_docs/sftp-batch-processing directory and put all of our documents in there. From now on, let's always create project-specific document folders like this. This should be a CRITICAL rule.
```

### 8. Documentation Integration Question
```
so does this mean we should update the main project_docs README.md to include content from this project-specific directory?
```

### 9. Documentation Strategy Clarification
```
no, let's not update the main project_docs README. let's just make sure that going forward whenever we have a new project/feature, we always create the project specific document folders.
```

### 10. CLAUDE.md Integration Confirmation
```
since you mentioned this is a rule that should be adopted going forward, should this go in CLAUDE.md instead of just the project_docs?
```

### 11. Value Object Preference
```
I prefer that we use the existing FileHash Value Object instead of creating anything new with SHA-256.
```

### 12. Unit Test Convention Request
```
could you also capture our unit test conventions in CLAUDE.md as well?
```

### 13. Agent Handoff
```
/handoff developer
```

### 14. Implementation Start
```
Let's start with test driving the entity by test-driving the repository class
```

### 15. Documentation Simplification
```
Actually, let's simplify this and remove the examples using self::getContainer()->get(). Let's just focus on the getService() approach.
```

### 16. Progress Check
```
ok, what's next?
```

---

## Key Prompts and Interactions

### Initial Feature Request
```
I have some existing files here tests/Files/usps/sftp/ that represent SFTP files that come over from USPS. I would like to create a way to process these files and put them into the database by building upon the existing UploadPostageExpenseService. However, there are some column differences in the SFTP files vs what we have in the current UploadPostageExpenseService. The SFTP files have these columns Job ID, Number of Pieces, Transaction Amount and I need to map them to the existing BatchPostageRecordMap columns reference, quantity_sent, and cost respectively.

I would also like to be able to keep track of which SFTP files we have processed so we don't process the same file twice.
```
**Context**: User wanted to extend existing postage upload functionality for SFTP files with different column mappings and duplicate prevention.

### Design Validation
```
this is a very solid design. I prefer "PostageProcessedFile" over "ProcessedFile" - nice choice there!
```
**Context**: User approved the design approach after Analyst agent presented comprehensive analysis.

### TDD Methodology Request
```
I would like to adopt a specific approach to TDD. I want to test-drive the entity by first test-driving the repository class. I want to put the test files in the tests directory, and I want to use AbstractKernelTestCase so that the tests actually interact with the real database. When the tests all pass, then I can run bin/console doctrine:migrations:diff to generate a migration from the entities. Does that sound good?
```
**Context**: User established TDD methodology preference for data operations with real database testing.

### Critical Documentation Request
```
This is a great approach! Could you capture this as a "Critical Directive" in the main CLAUDE.md such that any future agents or future sessions will adopt this approach going forward?
```
**Context**: User wanted to codify the TDD strategy for future consistency.

### Implementation Handoff
```
/handoff developer
```
**Context**: User transferred from Analyst to Developer agent to begin implementation.

### Value Object Preference
```
I prefer that we use the existing FileHash Value Object instead of creating anything new with SHA-256.
```
**Context**: User preferred reusing existing infrastructure over creating new components.

### Documentation Organization Request
```
Let's create a project_docs/sftp-batch-processing directory and put all of our documents in there. From now on, let's always create project-specific document folders like this. This should be a CRITICAL rule.
```
**Context**: User established organized documentation approach with feature-specific folders.

### Dependency Injection Simplification
```
Actually, let's simplify this and remove the examples using self::getContainer()->get(). Let's just focus on the getService() approach.
```
**Context**: User preferred consistent dependency injection patterns in test documentation.

---

## Effective Patterns Identified

### 1. **Incremental Feature Building**
- Start with analysis of existing codebase
- Build upon existing services rather than recreating
- Reuse existing value objects and patterns

### 2. **TDD with Real Database**
- Test-drive repository first to shape entity design
- Use AbstractKernelTestCase for real database operations
- Generate migrations only after tests pass

### 3. **Design Validation Points**
- Present comprehensive analysis before implementation
- Get explicit approval on architectural decisions
- Validate naming conventions early

### 4. **Documentation Integration**
- Capture critical practices in CLAUDE.md immediately
- Organize documentation in feature-specific folders
- Document dependency injection patterns for consistency

### 5. **Agent Handoff Strategy**
- Use analysis agent for comprehensive requirement gathering
- Transfer to developer agent for implementation
- Maintain full context through structured handoffs

---

## Technical Outcomes

- **PostageProcessedFile** entity with audit trail capabilities
- **SftpBatchPostageProcessorService** for batch orchestration
- **Enhanced BatchPostageRecordMap** with SFTP column mapping
- **ProcessSftpPostageFilesCommand** for console operations
- **22 tests** with TDD methodology (8 repository + 9 service + 5 integration)
- **Clean migration** for database schema changes

---

## Reusable Prompts for Similar Features

### For Column Mapping Features:
```
I need to extend [ExistingService] to handle files with different column mappings. The new files have columns [Column1, Column2, Column3] that should map to existing [Field1, Field2, Field3]. I also need duplicate prevention tracking.
```

### For TDD Implementation:
```
I want to test-drive this feature starting with the repository class, using AbstractKernelTestCase for real database operations, then generate the migration after tests pass.
```

### For Architecture Validation:
```
Please analyze the existing codebase and present a comprehensive design approach before implementation, including entity relationships, service orchestration, and integration points.
```